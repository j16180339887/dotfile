#!/bin/bash

[ "`whoami`" = root ] || exec sudo "$0" "$@"

if echo "$@" | grep -q "upgrade\|install\|dist-upgrade\|full-upgrade"; then
  cd /var/cache/apt/archives/;

  DOWNLOADARGS='-c -s16 -k1M -x16'
  DNS="--async-dns-server=8.8.8.8,180.76.76.76"
  if ! ping -c 1 8.8.8.8 | grep -q -i "ttl"; then
    DNS=""
  fi

  # Donload unfinished jobs
  [[ -f /var/cache/apt/archives/apt-fast.list ]] && aria2c $DOWNLOADARGS $DNS -i apt-fast.list

  # Create new jobs
  apt-get -y --print-uris $@ | egrep -o -e "(ht|f)tp[s]?://[^\']+" > apt-fast.list && aria2c -c $DOWNLOADARGS $DNS -i apt-fast.list
fi

apt $@ && rm -rf /var/cache/apt/archives/apt-fast.list
